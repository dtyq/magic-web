# planner.agent 用户确认功能实现设计

## 1. 概述

本设计方案旨在实现一个功能：在 planner.agent 生成 todo.md 任务清单后，不立即调用 finish_task，而是先调用 ask_user 工具等待用户确认或修改请求，只有在收到用户确认后才调用 finish_task。

## 2. 工作流程

修改后的工作流程如下：

1. planner.agent 分析用户任务需求，提取核心目标和限制
2. 设计执行计划并生成 todo.md 文件
3. 调用 ask_user 工具，向用户展示生成的任务清单并请求确认或修改
4. 等待用户回复
   - 如果用户回复确认，则调用 finish_task 结束任务
   - 如果用户回复修改请求，则根据用户的反馈调整 todo.md，然后再次调用 ask_user 请求确认
5. 在用户最终确认后，使用 finish_task 返回结果

## 3. 设计要点

### 3.1 ask_user 工具调用

- 在生成 todo.md 后使用 ask_user 工具发送消息给用户
- 消息内容使用扩展格式，包含 question 和 detail 字段
- detail 字段包含类型（如"todo"）和数据（如 todo.md 内容）
- ask_user 工具调用返回的 ToolResult 被系统标记为 "ASK_USER"，这会中断当前流程，等待用户回复

### 3.2 ask_user 工具返回结构

- ask_user 工具被调用后，系统会暂停当前代理的执行
- 当用户回复后，系统会继续执行代理流程
- 用户的回复内容会作为下一条用户消息添加到聊天历史中
- 代理可以通过读取最后一条用户消息来获取回复内容
- 具体获取方式是从聊天历史中提取最后一条用户消息的内容
- 系统不会自动解析用户回复，需要代理自行分析回复内容判断是确认还是修改

### 3.3 用户回复处理

- 代理需要分析用户的回复内容，判断是确认还是修改请求
- 确认回复的识别方式：
  - 回复中包含确认词汇（如"确认"、"同意"、"可以"、"好的"等）
  - 回复简短且不包含明确的修改指示

### 3.4 todo.md 修改逻辑

如果用户回复包含修改请求，代理需要：
1. 分析回复内容，提取修改指示
2. 读取当前 todo.md 内容
3. 根据修改指示调整任务清单
4. 使用 replace_in_file 或 write_to_file 工具更新 todo.md
5. 再次调用 ask_user 请求确认

## 4. 实现细节

### 4.1 修改 planner.agent 文件

1. 在 tools 列表中添加 ask_user
2. 修改 workflows 部分，添加向用户请求确认的流程
3. 添加处理用户回复的逻辑分支

### 4.2 ask_user 工具调用

```
ask_user(
  question: "我已经生成了任务计划，请确认或提出修改建议。你可以直接回复"确认"，或者提出修改意见。",
  detail: {
    "type": "todo",
    "data": {
      "content": "[todo.md内容]"
    }
  }
)
```

### 4.3 获取用户回复

在 ask_user 工具执行后，系统会暂停当前流程并等待用户回复。当用户回复后，系统会继续执行代理流程，此时代理可以通过以下方式获取用户回复：

```
// 用户回复会作为新的用户消息被添加到聊天历史
// 代理可以从当前执行的上下文中获取最近的用户消息内容
// 这通常由系统自动处理，代理会直接"看到"用户的回复内容
// 无需额外的工具调用来获取回复
```

### 4.4 用户回复分析

通过读取用户回复的内容，判断是确认还是修改请求：

```
if (用户回复内容中包含"确认"、"同意"、"可以"等) {
    // 视为确认，调用 finish_task
} else {
    // 视为修改请求，解析内容并修改 todo.md
}
```

### 4.5 处理修改请求

当用户提出修改请求时：

1. 分析用户的修改请求，识别需要添加、删除或修改的任务
2. 根据分析结果，修改 todo.md 文件
3. 再次调用 ask_user 请求确认

## 5. 代码示例

以下是 workflows 部分的修改示例：

```
<workflows>
while(true) {
    1. 分析用户任务需求，提取核心目标和关键限制
    2. 设计最小化但完整的执行计划，通常控制在3-5条高价值任务
    3. 检查 todo.md 文件是否已存在
       a. 如果存在:
          i. 读取 todo.md 文件内容，分析已有任务的完成情况
          ii. 如果所有任务都已完成(已标记为[x])，则重写 todo.md 以开展新任务
          iii. 如果仍有未完成任务，则基于已有内容进行精简或优化，确保不重复工作
       b. 如果不存在，则创建新的 todo.md 文件
    4. 读取生成的 todo.md 内容
    5. 使用 ask_user 工具请用户确认或提出修改建议:
       ask_user(
         question: "我已经生成了任务计划，请确认或提出修改建议。你可以直接回复"确认"，或者提出具体的修改意见。",
         detail: {
           "type": "todo",
           "data": {
             "content": "${todo_content}"
           }
         }
       )
    6. 分析用户回复:
       a. 如果回复表示确认:
          i. 继续下一步
       b. 如果回复包含修改建议:
          i. 分析修改内容
          ii. 更新 todo.md 文件
          iii. 返回步骤5请求再次确认
    7. 在用户确认后，使用 finish_task 返回结果，结果需要包括 todo.md 的文件路径和所有内容
    break
}
</workflows>
```

## 6. 注意事项

1. 用户回复分析逻辑应该具有一定的容错性，能处理各种形式的肯定回复
2. 在多次循环请求确认的过程中，应设置一个最大尝试次数，避免无限循环
3. 每次用户修改后，应在 ask_user 提问中明确指出已经做了哪些修改
4. 处理修改请求时应保留已标记为完成的任务状态
5. 日志记录应详细记录交互过程，便于调试和追踪 
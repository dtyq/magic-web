# Userscript 集成 TODO

- [x] 1. **创建 `Userscript` 数据模型 (`app/tools/magic_use/userscript.py`)**
    - [x] 定义 `Userscript` 类 (使用 `dataclasses.dataclass` 或 Pydantic `BaseModel`)。
    - [x] 包含字段：`name`, `version`, `description`, `match_patterns`, `exclude_patterns`, `content`, `file_path`, `run_at`。
    - [x] 添加类型提示和中文注释。
- [x] 2. **创建 `UserscriptManager` 类 (`app/tools/magic_use/userscript_manager.py`)**
    - [x] 实现为单例模式 (推荐使用模块级实例)。
    - [x] 在 `__init__` 中接收 `magic_monkey` 目录路径。
    - [x] 定义 `_scripts: List[Userscript]` 缓存列表。
    - [x] 定义 `logger`。
    - [x] 定义 `_lock: asyncio.Lock` 用于异步加载。
- [x] 3. **实现 `UserscriptManager` 的脚本加载与解析**
    - [x] 实现 `_parse_script_file(file_path: Path) -> Optional[Userscript]` 方法：
        - [x] 读取文件内容 (使用 `aiofiles`)。
        - [x] 使用正则表达式解析元数据块 (`// ==UserScript==` 到 `// ==/UserScript==`)。
        - [x] 提取 `@name`, `@version`, `@description`, `@match`, `@exclude`, `@run-at` 等标签。
        - [x] 处理 `@match` 和 `@exclude` (可能多个)，存为列表。
        - [x] 提取脚本主体内容。
        - [x] 处理解析错误，返回 `None` 或抛出异常。
        - [x] 创建并返回 `Userscript` 对象。
    - [x] 实现 `async load_scripts()` 方法：
        - [x] 使用 `asyncio.Lock` 和 `_initialized` 标记保护。
        - [x] 清空 `_scripts` 列表。
        - [x] 使用 `pathlib` 异步扫描 `magic_monkey` 目录下的 `.js` 文件。
        - [x] 对每个文件，调用 `_parse_script_file` (使用 `asyncio.gather`)。
        - [x] 将有效的 `Userscript` 对象添加到 `_scripts`。
        - [x] 添加日志记录。
- [x] 4. **实现 `UserscriptManager` 的 URL 匹配**
    - [x] 实现 `get_matching_scripts(url: str, run_at: str = "document-end") -> List[Userscript]` 方法：
        - [x] 遍历 `_scripts` 列表。
        - [x] 检查 `run_at` 时机是否匹配。
        - [x] 实现 URL 匹配逻辑 (使用 `fnmatch` 进行基本通配符匹配)。
        - [x] 过滤掉 `exclude` 匹配的脚本。
        - [x] 返回匹配的 `Userscript` 列表。
        - [x] 添加必要的类型检查和错误处理。
- [x] 5. **将 `UserscriptManager` 集成到 `PageRegistry` (`app/tools/magic_use/page_registry.py`)**
    - [x] 在 `page_registry.py` 顶部导入 `UserscriptManager`。
    - [x] 在 `PageRegistry.__init__` 中：
        - [x] 获取 `UserscriptManager` 单例实例。
        - [x] 异步调用 `userscript_manager.load_scripts()` 来加载脚本 (使用 `asyncio.create_task`)。
        - [x] 将 `UserscriptManager` 实例存储为 `self._userscript_manager`。
    - [x] 修改 `PageRegistry.register_page` 方法中的 `handle_page_load_and_script_injection` 内部函数。
    - [x] 在页面加载完成（`domcontentloaded`）后，并且在核心JS (`marker`, `pure`) 加载之后:
        - [x] 获取当前 `page.url`。
        - [x] 调用 `self._userscript_manager.get_matching_scripts(url=page.url, run_at='document-end')` (并处理 manager 未初始化的情况)。
        - [x] 遍历匹配的脚本列表。
        - [x] 对每个脚本，使用 `page.add_script_tag(content=script.content)` 注入。
        - [x] 添加错误处理和日志（包括页面关闭检查）。
- [ ] 6. **测试与验证**
    - [ ] 告知用户如何测试：打开一个匹配 `magic_monkey` 目录下某个脚本 `@match` 规则的网页，检查浏览器开发者工具的控制台或元素，确认脚本是否已注入并按预期执行。

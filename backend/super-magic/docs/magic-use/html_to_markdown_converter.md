# Magiclens 网页内容转Markdown技术方案

Magiclens 神奇透镜，洞穿网页本质。

## 需求背景
需要实现一个JavaScript闭包函数，能够智能地将网页上的文字和图片内容提取并转换为结构化的Markdown文本。与传统的HTML到Markdown转换不同，本方案需要模拟人类的阅读思维，筛选思路是提取页面中可见且有阅读价值的内容。

## 技术方案

脚本不要硬编码或揣测页面里的信息（如揣测页面的主要元素是什么（比如假定名字叫 main 的是主元素），揣测哪些是广告或者页脚等），这些都是你愚蠢的妄想，现实世界中的页面是千奇百怪的，要保证脚本的通用性。

要对 Dom 进行自上而下，由浅至深的递归遍历，保证 Markdown 的内容是有序生成的，能完美还原页面的结构，只是过滤掉所有人类不可读的信息。

### 核心思路
1. **人类思维模拟**：传统的方案只关注 HTML 信息，而本方案将采用"重点识别有阅读价值内容"的思路
2. **可见性优先**：只提取页面上实际可见的内容，忽略隐藏元素
3. **基于样式识别语义**：不仅仅依赖HTML标签类型，还通过分析样式属性（字体大小、粗细等）来确认 Markdown 样式是否要加粗、斜体等
4. **图片智能处理**：过滤无意义的装饰图片和data URI图片，去除各种人类阅读无关的干扰信息

### 技术实现

#### 一、内容识别阶段
1. **可见元素筛选**：
   - 使用`getComputedStyle`检查元素是否可见
   - 过滤`display: none`、`visibility: hidden`和尺寸为0的元素

2. **有价值内容识别**：
   - 文本内容：包含有意义文本的元素（排除显示出来无文字、无人类阅读价值的空白信息的元素）
   - 图片内容：有效的`<img>`标签，排除data URI和装饰性图片
   - 交互内容：有意义的链接和按钮文本

3. **还原 DOM 结构到 Markdown
   - Markdown 的内容也有层次结构，而非凌乱的碎片内容堆叠

#### 二、样式分析阶段
1. **计算样式提取**：
   - 使用`window.getComputedStyle()`获取元素完整的计算样式
   - 重点分析字体大小、粗细、颜色、行高等属性

2. **视觉重要性判断**：
   - 分析字体大小相对于页面基准字体的比例
   - 检测字体粗细（如`font-weight >= 600`识别为加粗文本）
   - 识别特殊颜色或背景色的文本（可能代表强调或重点内容）
   - 分析行高和边距判断段落和分隔

3. **样式模式识别**：
   - 对比分析页面中不同文本的样式模式
   - 识别重复的样式模式（如24px粗体可能是大标题）
   - 建立样式-语义映射关系（如特定样式组合→h1级标题）

4. **位置和布局评估**：
   - 分析元素在视口中的位置（顶部内容通常更重要）
   - 检测元素的宽度（通常全宽度内容为主要内容）
   - 识别居中文本（可能是标题或强调内容）

#### 三、结构化重建阶段
1. **构建内容层次**：
   - 结合DOM关系和样式分析重建内容的层次结构
   - 同时考虑HTML语义标签和视觉样式特征进行决策
   - 基于样式特征动态判断标题级别，而非机械遵循h1-h6

2. **去重处理**：
   - 跟踪已处理节点避免重复
   - 当子元素已被单独处理时，从父元素内容中排除

3. **解决冲突处理**：
   - 当标签语义与样式语义冲突时，优先考虑样式特征
   - 如`<p>`标签但字体特大加粗，应处理为标题

#### 四、Markdown生成阶段
1. **样式驱动的语义转换**：
   - 基于样式分析结果生成对应的Markdown语法
   - 样式大于标签，例如即使不是h1标签，但如果字体特别大也生成为`## 标题`
   - 根据字体粗细自动应用加粗标记`**文本**`
   - 根据字体样式（如斜体）应用相应Markdown标记

2. **图片处理**：
   - 提取图片URL，生成`![alt](url)`格式
   - 对于缺少alt的图片，生成描述性替代文本
   - 保留有意义的图片，过滤异常图片、如不合理的超长链接图片

3. **链接处理**：
   - 转换超链接为`[text](url)`格式
   - 保留有意义的链接，过滤无用链接、不合理的超长链接

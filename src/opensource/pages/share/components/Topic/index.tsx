import FooterIcon from "@/opensource/pages/share/assets/icon/footer_icon.svg"
import AttachmentList from "@/opensource/pages/superMagic/components/AttachmentList"
import Detail from "@/opensource/pages/superMagic/components/Detail"
import LoadingMessage from "@/opensource/pages/superMagic/components/LoadingMessage"
import Node from "@/opensource/pages/superMagic/components/MessageList/components/Node"
import TaskList from "@/opensource/pages/superMagic/components/TaskList"
import type { TaskData } from "@/opensource/pages/superMagic/pages/Workspace/types"
import ReplayLogo from "@/opensource/pages/share/assets/icon/replay_logo.svg"
import PreviewDetailPopup from "@/opensource/pages/superMagicMobile/components/PreviewDetailPopup/index"
import { IconFolder, IconLayoutGrid, IconLogin } from "@tabler/icons-react"
import { Button } from "antd"
import { Popup, SafeArea } from "antd-mobile"
import { isEmpty } from "lodash-es"
import { useCallback, useEffect, useLayoutEffect, useRef, useState } from "react"
import { useNavigate } from "react-router-dom"
import MessageList from "../MessageList"
import { useStyles } from "./style"

export default function Topic({
	data,
	resource_name,
	isMobile,
	attachments,
	menuVisible,
	setMenuVisible,
	isLogined,
}: {
	data: any
	resource_name: string
	isMobile: boolean
	attachments: any
	menuVisible: boolean
	setMenuVisible: (visible: boolean) => void
	isLogined: boolean
}) {
	const { styles } = useStyles()
	const [taskData, setTaskData] = useState<TaskData | null>(null)
	const previewDetailPopupRef = useRef(null) as any
	const [messageList, setMessageList] = useState<any[]>([])
	const [autoDetail, setAutoDetail] = useState<any>({})
	const [userDetail, setUserDetail] = useState<any>({})
	const timerRef = useRef<any>({})
	const messageContainerRef = useRef<HTMLDivElement>(null)
	const [taskIsEnd, setTaskIsEnd] = useState(false)
	const [isBottom, setIsBottom] = useState(false)
	const navigate = useNavigate()
	const [attachmentVisible, setAttachmentVisible] = useState(false)
	const [hasStarted, setHasStarted] = useState(false)
	const [countdown, setCountdown] = useState(10)
	// const [userDetail, , setUserDetail] = useState()

	// ÂàùÂßãÂä†ËΩΩÂâç10Êù°Ê∂àÊÅØ
	useEffect(() => {
		if (data?.list?.length) {
			// Âè™Âä†ËΩΩÂâç10Êù°Ê∂àÊÅØÔºåÊàñËÄÖÂ¶ÇÊûúÊÄªÊù°Êï∞Â∞ë‰∫é10ÂàôÂÖ®ÈÉ®Âä†ËΩΩ
			const initialCount = Math.min(10, data.list.length)
			const initialMessages = data.list.slice(0, initialCount)
			setMessageList(initialMessages)
		}
	}, [data])

	// Â§ÑÁêÜÂºÄÂßãÊòæÁ§∫Ê∂àÊÅØ
	const startShowingMessages = useCallback(() => {
		if (!data?.list?.length || hasStarted) return
		setHasStarted(true)
		setIsBottom(false)
		// Á°Æ‰øùÊ∏ÖÈô§‰ªª‰ΩïÁé∞ÊúâÁöÑÂÆöÊó∂Âô®
		if (timerRef.current.timer) {
			clearInterval(timerRef.current.timer)
		}

		// Ê∏ÖÁ©∫Ê∂àÊÅØÂàóË°®ÔºåÈáçÊñ∞ÂºÄÂßã
		setMessageList([])

		// ‰ªéÂ§¥ÂºÄÂßãÂä†ËΩΩÊ∂àÊÅØ
		let currentIndex = 0
		timerRef.current.timer = setInterval(() => {
			if (currentIndex < data.list.length) {
				const newMessage = data.list[currentIndex]
				if (newMessage?.tool?.detail) {
					setAutoDetail?.(newMessage?.tool?.detail)
				}
				setMessageList((prev: any[]) => [...prev, newMessage])
				currentIndex += 1
			} else {
				clearInterval(timerRef.current.timer)
			}
		}, 400)
	}, [data, hasStarted])

	// ÂÄíËÆ°Êó∂Ëá™Âä®ÂºÄÂßãÊòæÁ§∫
	useEffect(() => {
		if (hasStarted || !data?.list?.length) return undefined

		// Ê∏ÖÈô§‰ªª‰ΩïÁé∞ÊúâÁöÑÂÆöÊó∂Âô®
		if (timerRef.current.countdownTimer) {
			clearInterval(timerRef.current.countdownTimer)
		}

		timerRef.current.countdownTimer = setInterval(() => {
			setCountdown((prev) => {
				if (prev <= 1) {
					clearInterval(timerRef.current.countdownTimer)
					startShowingMessages()
					return 0
				}
				return prev - 1
			})
		}, 1000)

		return () => {
			if (timerRef.current.countdownTimer) {
				clearInterval(timerRef.current.countdownTimer)
			}
		}
	}, [data, hasStarted, startShowingMessages, messageList])

	// ÊªöÂä®Âà∞Ê∂àÊÅØÂàóË°®ÁöÑÂêàÈÄÇ‰ΩçÁΩÆÔºåÁ°Æ‰øùÂàùÂßãÊ∂àÊÅØÂèØËßÅ
	useEffect(() => {
		if (messageList.length > 0 && !hasStarted) {
			const container = messageContainerRef.current
			if (container) {
				// ÊªöÂä®Âà∞50%È´òÂ∫¶‰ΩçÁΩÆÔºåËÆ©‰∏äÂçäÈÉ®ÂàÜÊ∂àÊÅØÂèØËßÅ
				container.scrollTop = container.scrollHeight * 0.3
			}
		}
	}, [messageList, hasStarted])

	// Ê∏ÖÁêÜÂÆöÊó∂Âô®
	useEffect(() => {
		return () => {
			if (timerRef.current.timer) {
				clearInterval(timerRef.current.timer)
			}
			if (timerRef.current.countdownTimer) {
				clearInterval(timerRef.current.countdownTimer)
			}
		}
	}, [])

	const handlePreviewDetail = useCallback(
		(item: any) => {
			previewDetailPopupRef.current?.open(item, attachments.tree)
		},
		[attachments],
	)

	const isAtBottomRef = useRef(true) // üëà Áî® ref ‰øùÂ≠òÊóßÁöÑ isAtBottom Áä∂ÊÄÅ

	useEffect(() => {
		const el = messageContainerRef.current
		if (!el) return

		const handleScroll = () => {
			const distanceFromBottom = el.scrollHeight - el.scrollTop - el.clientHeight
			isAtBottomRef.current = distanceFromBottom < 30
		}

		el.addEventListener("scroll", handleScroll)
		return () => el.removeEventListener("scroll", handleScroll)
	}, [messageList])

	// üëá 2. Âú® DOM ÂÆåÊàêÊ∏≤ÊüìÂêéÂÜçÂà§Êñ≠Ë¶Å‰∏çË¶ÅÊªöÂà∞Â∫ïÈÉ®
	useLayoutEffect(() => {
		const el = messageContainerRef.current
		if (!el) return

		if (isAtBottomRef.current) {
			requestAnimationFrame(() => {
				el.scrollTo({
					top: el.scrollHeight,
					behavior: "smooth",
				})
			})
		}
	}, [messageList]) // üëà Ê≥®ÊÑèÔºöËøôÈáå‰∏çËÉΩÂÜçÂà§Êñ≠ isScrolledToBottomÔºåËÄåÊòØÁî®‰πãÂâçËÆ∞ÂΩïÁöÑ isAtBottomRef

	useEffect(() => {
		if (messageList.length === data?.list?.length) {
			setIsBottom(true)
		}
	}, [messageList.length, data?.list?.length])

	// ÂΩìÊ∂àÊÅØÂàóË°®ÂèòÂåñÊó∂ÔºåÊü•ÊâæÊúÄÂêé‰∏ÄÊù°Êúâtask‰∏îtask.processÈïøÂ∫¶‰∏ç‰∏∫0ÁöÑÊ∂àÊÅØ
	useEffect(() => {
		if (messageList && messageList.length > 0) {
			// ‰ªéÂêéÂæÄÂâçÈÅçÂéÜÊâæÂà∞Á¨¨‰∏Ä‰∏™Á¨¶ÂêàÊù°‰ª∂ÁöÑÊ∂àÊÅØ
			let foundTaskData = false
			for (let i = messageList.length - 1; i >= 0; i -= 1) {
				const message = messageList[i]
				if (message?.steps && message?.steps?.length > 0) {
					// ËÆæÁΩÆ‰∏∫ÂΩìÂâç‰ªªÂä°Êï∞ÊçÆ
					setTaskData({
						process: message.steps,
						topic_id: message.topic_id,
					})
					foundTaskData = true
					break
				}
			}
			// Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑÊ∂àÊÅØÔºåÊ∏ÖÁ©∫TaskData
			if (!foundTaskData) {
				setTaskData(null)
			}
			const lastMessageWithTaskId = messageList
				.slice()
				.reverse()
				.find((message) => message.role === "assistant")
			const lastMessage = messageList[messageList.length - 1]
			const isLoading =
				lastMessageWithTaskId?.status === "running" || lastMessage?.text?.content
			setTaskIsEnd(!isLoading)
		} else {
			// Â¶ÇÊûúÊ∂àÊÅØÂàóË°®‰∏∫Á©∫Ôºå‰πüÊ∏ÖÁ©∫TaskData
			setTaskData(null)
		}
	}, [messageList])

	// Áõ¥Êé•ÊòæÁ§∫ÁªìÊûúÁöÑÂ§ÑÁêÜÔºöÁ´ãÂç≥Âä†ËΩΩÊâÄÊúâÊ∂àÊÅØÔºåÂÅúÊ≠¢ÂÄíËÆ°Êó∂
	const handleShowResult = useCallback(() => {
		setUserDetail({})
		setHasStarted(true)
		// Êü•ÊâæÊâÄÊúâÊ∂àÊÅØ‰∏≠Â∏¶ÊúâËØ¶ÊÉÖÁöÑÊúÄÂêé‰∏ÄÊù°
		const lastDetailItem = [...data.list]
			.reverse()
			.find((item) => item?.tool?.detail && !isEmpty(item.tool.detail))
		if (lastDetailItem?.tool?.detail) {
			setAutoDetail(lastDetailItem.tool.detail)
		}

		// Ê∏ÖÈô§ÊâÄÊúâÂÆöÊó∂Âô®
		if (timerRef.current.timer) {
			clearInterval(timerRef.current.timer)
		}
		if (timerRef.current.countdownTimer) {
			clearInterval(timerRef.current.countdownTimer)
		}

		// ‰∏ÄÊ¨°ÊÄßËÆæÁΩÆÊâÄÊúâÊ∂àÊÅØ
		setMessageList(data.list)

		// ÊªöÂä®Âà∞Â∫ïÈÉ®
		requestAnimationFrame(() => {
			const container = messageContainerRef.current
			if (container) {
				container.scrollTo({
					top: container.scrollHeight,
					behavior: "smooth",
				})
			}
		})
		setIsBottom(true)
	}, [data.list])

	return (
		<>
			<div className={styles.topicContainer}>
				<PreviewDetailPopup
					ref={previewDetailPopupRef}
					setUserSelectDetail={(detail) => {
						handlePreviewDetail(detail)
					}}
					onClose={() => {
						handlePreviewDetail(autoDetail)
					}}
				/>

				{hasStarted && (
					<>
						{isMobile ||
						(isEmpty(taskData) && isEmpty(attachments.tree)) ||
						(isEmpty(taskData) && !isEmpty(attachments.tree) && !isBottom) ? null : (
							<div className={styles.leftContainer}>
								{!isEmpty(taskData) ? (
									<div className={styles.taskData}>
										<TaskList taskData={taskData} mode="view" />
									</div>
								) : null}
								{!isEmpty(attachments.tree) && isBottom && (
									<div className={styles.attachmentList}>
										<AttachmentList
											attachments={attachments.tree}
											setUserSelectDetail={setUserDetail}
										/>
									</div>
								)}
							</div>
						)}
						{!isEmpty(autoDetail) || !isEmpty(userDetail) ? (
							isMobile ? null : (
								<div className={styles.detail}>
									<Detail
										disPlayDetail={
											isEmpty(userDetail) ? autoDetail : userDetail
										}
										attachments={attachments.tree}
										userSelectDetail={userDetail}
										setUserSelectDetail={setUserDetail}
									/>
								</div>
							)
						) : null}
					</>
				)}

				<div
					className={`${styles.messageContainer} ${
						(isEmpty(taskData) && isEmpty(autoDetail) && isEmpty(userDetail)) ||
						!hasStarted
							? styles.fullWidthMessageContainer
							: ""
					} ${!hasStarted ? styles.messageContainerNotStarted : ""}`}
				>
					<div className={styles.messageListHeader}>{resource_name || "ÈªòËÆ§ËØùÈ¢ò"}</div>
					<div className={styles.messageListContainer} ref={messageContainerRef}>
						<MessageList
							messageList={messageList}
							onSelectDetail={(detail) => {
								setUserDetail(detail)
								if (isMobile) {
									handlePreviewDetail(detail)
								}
							}}
						/>
						{!taskIsEnd && messageList?.length > 0 && !hasStarted && <LoadingMessage />}
					</div>
				</div>
			</div>

			{hasStarted && (
				<div className={styles.footer}>
					<div className={styles.footerContent}>
						<div className={styles.footerLeft}>
							<img src={FooterIcon} alt="" className={styles.footerIcon} />
							<span>Ë∂ÖÁ∫ßÈ∫¶Âêâ {taskIsEnd ? "‰ªªÂä°ÂÆåÊàê" : "Ê≠£Âú®ÊâßË°å‰ªªÂä°..."}</span>
						</div>
						{!isBottom ? (
							<Button type="primary" onClick={handleShowResult}>
								Áõ¥Êé•ÊòæÁ§∫ÁªìÊûú
							</Button>
						) : null}
					</div>
				</div>
			)}
			{!hasStarted && (
				<div className={styles.waitingContainer}>
					<div className={styles.replayLogoContainer}>
						<div className={styles.overlay}></div>
						<div className={styles.replayLogoDiv}>
							<img src={ReplayLogo} alt="" className={styles.replayLogo} />
						</div>
					</div>
					<div className={styles.watingTitleWrapper}>
						<div className={styles.watingTitle}>ÊÇ®Ê≠£Âú®Êü•Áúã‰ªªÂä° „Äå{resource_name}„Äç</div>
					</div>
					<div className={styles.waitingTextWrapper}>
						<div className={styles.waitingText}>ÂõûÊîæÂ∞ÜÂú® {countdown} ÁßíÂêéËá™Âä®ÂºÄÂßã</div>
					</div>
					<Button
						type="primary"
						onClick={startShowingMessages}
						className={styles.waitingButton}
					>
						Á´ãÂç≥Êü•Áúã
					</Button>
				</div>
			)}
			<Popup
				visible={menuVisible}
				bodyStyle={{ width: "80%", backgroundColor: "#fff", padding: "20px" }}
				position="right"
				onMaskClick={() => {
					setMenuVisible(false)
				}}
			>
				<SafeArea position="top" />
				<div className={styles.menuContainer}>
					<div className={styles.title}>ÂØºËà™</div>
					{!isLogined ? (
						<div className={styles.item} onClick={() => navigate("/login")}>
							<IconLogin className={styles.icon} />
							ÁôªÂΩï
						</div>
					) : (
						<div className={styles.item} onClick={() => navigate("/super/workspace")}>
							<IconLayoutGrid className={styles.icon} />
							ËøõÂÖ•Â∑•‰ΩúÂå∫
						</div>
					)}
				</div>
				<div className={styles.menuContainer}>
					<div className={styles.title}>ËØùÈ¢ò</div>
					<div className={styles.item} onClick={() => setAttachmentVisible(true)}>
						<IconFolder className={styles.icon} /> <span>Êü•ÁúãËØùÈ¢òÊñá‰ª∂</span>
					</div>
				</div>
				<SafeArea position="bottom" />
			</Popup>
			<Popup
				onMaskClick={() => {
					setAttachmentVisible(false)
				}}
				visible={attachmentVisible}
				bodyStyle={{ height: "90%", backgroundColor: "#fff" }}
			>
				<SafeArea position="top" />
				<div className={styles.attachmentList}>
					<AttachmentList
						attachments={attachments.tree}
						setUserSelectDetail={(detail) => {
							setUserDetail(detail)
							if (isMobile) {
								handlePreviewDetail(detail)
							}
						}}
					/>
				</div>
				<SafeArea position="bottom" />
			</Popup>
		</>
	)
}
